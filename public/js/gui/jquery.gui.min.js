!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("jQuery")):"function"==typeof define&&define.amd?define(["jQuery"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jQuery)}(this,function(e){"use strict";const t={merge:$.extend,each:Object.prototype.forEach,has:Object.prototype.hasOwnProperty,slice:Array.prototype.slice,isObj:e=>$.isPlainObject(e),isArr:e=>$.isArray(e),isFunc:e=>!!(e&&e.constructor&&e.call&&e.apply),isStr:e=>"string"==typeof e,isType:(e,t,r)=>{if(typeof t!==e)return`Error :: ${r} must be of type ${e}`},hasArgs:(e,t=1)=>{const r=e.toString().match(/\(([^)]*)\)/);return(r&&r[1].match(/[^\s,]+/g)||[]).length>=t},inject:(e,r)=>{var s;for(s in r)t.hasProp.call(r,s)&&(e[s]=r[s]);function n(){this.constructor=e}return n.prototype=r.prototype,e.prototype=new n,e.__super__=r.prototype,e},isRetina:()=>window.retina||window.devicePixelRatio>1,isMobile:e=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e),getObjectSize:e=>{var t,r=0;for(t in e)e.hasOwnProperty(t)&&(r+=1);return r},getPxValue:(e,t)=>{var r;switch(t){case"em":r=this.convertToEm(e);break;case"pt":r=this.convertToPt(e);break;default:r=e}return r},rand:(e,t)=>Math.floor(Math.random()*(t-e+1))+e,args:e=>{var r;return((null!==e&&null!==(r=e.toString().match(t.fnRgx))?r[1]:void 0)||"").match(t.argRgx)||[]},resize:e=>{e.height||(e=$(e)),$(()=>{$(window).resize(()=>{e.height($(window).height())}),$(window).resize()})},slugify:e=>e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,""),clone:e=>{var t,r,s;if(e instanceof Array)t=(()=>{var t,r,n;for(n=[],t=0,r=e.length;t<r;t++)s=e[t],n.push(s);return n})();else for(r in t={},e)s=e[r],t[r]=s;return t},convertToEm:e=>e*this.getFontsize(),convertToPt:e=>{},convertBase:()=>{var e=document.createElement(),t=e.getAttribute("style");return e.setAttribute("style",t+";font-size:1em !important"),e.setAttribute("style",t),base=this.getFontsize(),base},mix:(e,t,r)=>{var s,n,o;if(!0===r){for(s in n=[],e)o=e[s],n.push(t[s]=o);return n}for(s in e)o=e[s],t.hasOwnProperty(s)||n.push(t[s]=o);return n},mixin:function(e,t,r){switch(r&&null!==r||(r=!1),typeof t+"-"+typeof e){case" - ":return this.mix(t.prototype,e.prototype,r);case" -object":return this.mix(t.prototype,e,r);case"object-object":return this.mix(t,e,r);case"object- ":return this.mix(t,e.prototype,r)}},unique:e=>{var t="";for(e&&null!==e||(e=8);t.length<e;)t+=Math.random().toString(36).substr(2);return t.substr(0,e)},run:{series:(e=[])=>e.length?e.reduce((e,t,r)=>e.then(e=>Promise.resolve(t()).then(t=>[...e,t]).catch(e=>{const t=new Error(`Task ${r} failed`);throw t.originalError=e,t})),Promise.resolve([])):Promise.resolve([]),parallel:(e=[])=>e.length?Promise.all(e.map(e=>Promise.resolve(e()))):Promise.resolve([]),first:(e=[])=>e.length?e[0]().catch(()=>{if(e.length>1)return t.run.first(e.slice(1));throw new Error("All tasks failed")}):Promise.resolve(null)}},r=function(e={}){const s=this;return this.channels={},this.cascade=e.cascade||!1,this.fireOrigin=e.fireOrigin||!1,this.debug=e.debug||!1,this._delete=(e,r,s)=>{if(!this.channels[e])return[];const n=this.channels[e].length;this.channels[e]=this.channels[e].filter(e=>(!r||e.callback!==r)&&((!s||e.context!==s)&&!(!r&&!s&&e.context===this)));const o=n-this.channels[e].length;return o>0&&t.log(`Removed ${o} subscription(s) from '${e}'`),this.channels[e]},this._setupTasks=(e,r,s)=>(this.channels[r]||[]).map(r=>()=>new Promise((n,o)=>{try{if(t.hasArgs(r.callback,3))r.callback.call(r.context,e,s,(e,t)=>{e?o(e):n(t)});else{const t=r.callback.call(r.context,e,s);t&&"function"==typeof t.then?t.then(n,o):n(t)}}catch(e){o(e)}})),this._formatErrors=e=>{if(t.isArr(e)){const t=e.filter(e=>null!=e).map(e=>e.message||String(e)),r=new Error(t.join("; "));return r.originalErrors=e,r}return e},{create:()=>new r,add:(e,t,r)=>{if("string"!=typeof e)throw new Error("Channel must be a string");if("function"!=typeof t)throw new Error("Callback must be a function");this.channels[e]||(this.channels[e]=[]);const s={event:e,context:r||this,callback:t};return this.channels[e].push(s),this},remove:(e,t,r)=>{switch(typeof e){case"string":"function"==typeof t?this._delete(e,t,r):void 0===t&&this._delete(e);case"function":Object.keys(this.channels).forEach(t=>{_this._delete(t,e)});case"undefined":this.clear();case null!==e:Object.keys(this.channels).forEach(t=>{this._delete(t,null,e)})}return this},once(e,t,r){if("string"!=typeof e)throw new Error("Channel must be a string");if("function"!=typeof t)throw new Error("Callback must be a function");let s=!1;const n=(...o)=>{if(!s)return s=!0,this.remove(e,n),t.apply(r||this,o)};return this.add(e,n,r)},clear(){return Object.keys(this.channels).forEach(e=>delete this.channels[e]),log("All this.channels cleared"),this},fire(e,r){if("string"!=typeof e)return Promise.reject(new Error("Channel must be a string"));"function"==typeof r&&(r=void 0);const n=s._setupTasks(r,e,e);return 0===n.length?Promise.resolve(null):t.run.first(n).catch(e=>{throw s._formatErrors(e)})},emit(e,r,n){if("string"!=typeof e)return Promise.reject(new Error("Channel must be a string"));r&&t.isFunc(r)&&(r=void 0),n=n||e;const o=s._setupTasks(r,e,n);return t.run.series(o).then(t=>{if(s.cascade){const s=e.split("/");if(s.length>1){const e=s.slice(0,-1).join("/"),o=fireOrigin?n:e;return this.emit(e,r,o).then(()=>t)}}return t}).catch(e=>{throw s._formatErrors(e)})},waitFor(e,t){return new Promise((r,s)=>{let n;t&&t>0&&(n=setTimeout(()=>{this.remove(e,o),s(new Error(`Timeout waiting for event '${e}' after ${t}ms`))},t));const o=(t,s)=>{n&&clearTimeout(n),this.remove(e,o),r({data:t,origin:s,channel:e})};this.add(e,o)})},pipe(e,t,r){return t&&(t.fire||t.emit)&&(r=t,t=e),r||(r=this),r===this&&e===t||this.add(e,(...e)=>r.fire(t,...e)),this},namespace(e){const t=e+"/";return{add:(e,r,s)=>this.add(t+e,r,s),remove:(e,r,s)=>this.remove(t+e,r,s),fire:(e,r)=>this.fire(t+e,r),emit:(e,r,s)=>this.emit(t+e,r,s),once:(e,r,s)=>this.once(t+e,r,s),waitFor:(e,r)=>this.waitFor(t+e,r),pipe:(e,r,s)=>this.pipe(t+e,t+r,s),getSubscriberCount:e=>this.getSubscriberCount(t+e),clear:()=>(Object.keys(this.channels).forEach(e=>{e.startsWith(t)&&delete this.channels[e]}),this)}},install:(e,r=!1)=>t.isObj(e)?(Object.keys(this).forEach(t=>{const s=this[t];"function"!=typeof s||!r&&e[t]||(e[t]=s.bind(this))}),this):this,getchannels:()=>Object.keys(this.channels).filter(e=>this.channels[e]&&this.channels[e].length>0),getSubscriberCount:e=>this.channels[e]&&this.channels[e].length||0}},s=(new r).create(),n=function(e={}){const s=new Map,n=new r;let o=e;const i=e=>{if(!s.has(e))return!1;const t=s.get(e);if(t&&"function"==typeof t.destroy)try{t.destroy()}catch(t){console.error(`Error destroying module ${e}:`,t)}return s.delete(e),n.remove(`module:${e}`),n.emit("module:unregistered",{name:e}).catch(e=>{console.error("Error emitting unregister event:",e)}),console.log(`Module unregistered: ${e}`),!0},a=()=>Array.from(s.keys()),c={create:()=>c,register:(e,t)=>{if(!e||"string"!=typeof e)throw new Error("Module name must be a non-empty string");return s.set(e,t),n.add(`module:${e}`,()=>({name:e,instance:t})),n.emit("module:registered",{name:e,instance:t}).then(()=>{console.log(`Module registered: ${e}`)}).catch(e=>{console.error("Error registering module:",e)}),t},unregister:i,get:e=>s.get(e),has:e=>s.has(e),list:a,clear:()=>{a().forEach(e=>i(e)),s.clear()},setGlobal:e=>(o=t.isObj(e)?t.merge({},o,e):o,o),getGlobal:()=>o,on:(e,t,r)=>n.add(e,t,r),off:(e,t,r)=>n.remove(e,t,r),emit:(e,t)=>n.emit(e,t),fire:(e,t)=>n.fire(e,t),broker:n};return c},o=function(){const s=this;this.config={logLevel:0,name:"FEAR_GUI",version:"2.0.0"},this.debug={history:[],level:this.config.logLevel,timeout:5e3,warn(...e){s.debug.level<2&&(console.warn("WARN:",...e),s.debug.history.push({type:"warn",args:e}))},log(...e){s.debug.level<1&&(console.log("Debug:",...e),s.debug.history.push({type:"log",args:e}))}},this.state={modules:{},plugins:[],instances:{},sandboxes:{},running:{},imports:[]},this.broker=(new r).create(),this.registry=(new n).create(this.config),this.utils=t;const o=(e,r)=>{const n=r.instanceId||e;if(s.state.instances[n])return Promise.resolve({instance:s.state.instances[n],options:r.options});const o=s.state.modules[e],i={...o.options,...r.options},a=((e,r,s={},n)=>{const o={id:r,module:n,options:s,utils:t};return console.log("gui in sandbox = ",e),e.broker.install(o),o.broker=e.broker,o.add=e.broker.add.bind(e.broker),o.remove=e.broker.remove.bind(e.broker),o.emit=e.broker.emit.bind(e.broker),o.fire=e.broker.fire.bind(e.broker),o.data=$.data,o.deferred=()=>$.Deferred(),o.animation=$.Animation,o.fetch=(e,t={})=>new Promise((r,s)=>{$.ajax({url:"string"==typeof e?e:e.url,...t,success:(e,t,s)=>r({data:e,textStatus:t,jqXHR:s}),error:(e,t)=>s(new Error(t||"Ajax failed"))})}),o.query=(e,t)=>{const r=t&&t.find?t.find(e):$(e);return r.query=e=>o.query(e,r),r.create=e=>document.createElement(e),r.size=()=>parseFloat(window.getComputedStyle(r[0]||r).fontSize),r.animateAsync=(e,t,s)=>new Promise((n,o)=>{try{r.animate(e,{duration:t,easing:s,complete:()=>n(r),fail:e=>o(e)})}catch(e){o(e)}}),r.onAsync=(e,t)=>new Promise(s=>{const n=o=>{r.off(e,t,n),s(o)};t?r.on(e,t,n):r.on(e,n)}),r},o.$=o.query,o.timeout=(e,t)=>new Promise(r=>{setTimeout(()=>r(t&&"function"==typeof t?t():void 0),e)}),o.interval=(e,t,r)=>{let s,n=0,o=!1;return{stop:()=>{o=!0,s&&clearInterval(s)},promise:new Promise((i,a)=>{s=setInterval(()=>{if(o)return clearInterval(s),void i(n);try{e(),n++,r&&n>=r&&(clearInterval(s),i(n))}catch(e){clearInterval(s),a(e)}},t)})}},o.hitch=(e,...t)=>function(...r){const s=t.concat(r);return e.apply(this,s)},o.memoize=(e,t,r)=>(t=t||{},(...s)=>{const n=s.length>1?s.join("__"):String(s[0]||"");if(!(n in t)||r&&t[n]===r){const r=e.apply(e,s);r&&"function"==typeof r.then?t[n]=r.catch(e=>{throw delete t[n],e}):t[n]=r}return t[n]}),o.loadResources=(e,t={})=>{const r=(Array.isArray(e)?e:[e]).map(e=>{if("string"==typeof e){const t=e;switch(t.split(".").pop().toLowerCase()){case"css":return o.loadCSS(t);case"js":return o.loadScript(t);case"json":return o.fetch(t).then(e=>e.data);default:return o.fetch(t)}}else if(e&&e.type&&e.url)switch(e.type){case"css":return o.loadCSS(e.url);case"script":return o.loadScript(e.url);case"json":return o.fetch(e.url).then(e=>e.data);default:return o.fetch(e.url)}return Promise.reject(new Error("Invalid resource format"))});return Promise.all(r)},o.loadCSS=e=>new Promise((t,r)=>{const s=document.createElement("link");s.rel="stylesheet",s.type="text/css",s.href=e,s.onload=()=>t(s),s.onerror=()=>r(new Error(`Failed to load CSS: ${e}`)),document.head.appendChild(s)}),o.loadScript=e=>new Promise((t,r)=>{const s=document.createElement("script");s.type="text/javascript",s.src=e,s.onload=()=>t(s),s.onerror=()=>r(new Error(`Failed to load script: ${e}`)),document.head.appendChild(s)}),o.getLocation=()=>e.config.win&&win.location,o.log=(...t)=>e.debug.log(...t),o.warn=(...t)=>e.debug.warn(...t),o.ready=()=>new Promise(e=>$(document).ready(e)),o.loaded=()=>new Promise(e=>$(window).on("load",e)),o})(s,n,i,e);return((e,r)=>{const n=s.state.plugins.filter(t=>"function"==typeof t.plugin?.[e]).map(t=>()=>Promise.resolve(t.plugin[e](r,t.options)));return t.run.series(n)})("load",a).then(()=>{const e=o.creator(a);if("function"!=typeof e.load){if(e.fn&&"function"==typeof e.fn)return s.plugin(e,n),{instance:e,options:i};throw new Error("module has no 'load' or 'fn' method")}return s.state.instances[n]=e,s.state.sandboxes[n]=a,s.registry.register(n,e),{instance:e,options:i}})},i=e=>{e||(e=Object.keys(s.state.modules));const r=e.map(e=>()=>s.start(e,s.state.modules[e].options));return t.run.parallel(r)};return this.configure=e=>(e&&t.isObj(e)&&(s.config=t.merge(s.config,e),s.registry.setGlobal(s.config),s.debug.level=s.config.logLevel||0),s),this.create=(e,r,n={})=>{const o=t.isType("string",e,"module ID")||t.isType("function",r,"creator")||t.isType("object",n,"option parameter");return o?(s.debug.warn(`could not register module '${e}': ${o}`),s):(s.state.modules[e]={id:e,creator:r,options:n},s)},this.start=(e,r={})=>{const n=r.instanceId||e,a=t.isType("string",e,"module ID")||t.isType("object",r,"second parameter")||(s.state.modules[e]?void 0:"module doesn't exist");return e?t.isArr(e)?i(e):t.isFunc(e)?i():a?Promise.reject(new Error(a)):!0===s.state.running[n]?Promise.reject(new Error("module was already started")):s.boot().then(()=>o(e,r)).then(({instance:e,options:t})=>{if(e.load&&"function"==typeof e.load){const r=e.load(t);return r&&"function"==typeof r.then?r.then(()=>{s.state.running[n]=!0}):(s.state.running[n]=!0,Promise.resolve())}return s.state.running[n]=!0,Promise.resolve()}).catch(e=>{throw s.debug.warn(e),new Error("could not start module: "+e.message)}):i()},this.stop=e=>{if(0===arguments.length||"function"==typeof e){const e=Object.keys(s.state.instances);return t.run.parallel(e.map(e=>()=>s.stop(e)))}const r=s.state.instances[e];return r?(delete s.state.instances[e],s.broker.remove(r),s.registry.unregister(e),s._runInstPlugins("unload",s.state.sandboxes[e]).then(()=>{if(r.unload&&"function"==typeof r.unload){const e=r.unload();if(e&&"function"==typeof e.then)return e}return Promise.resolve()}).then(()=>{delete s.state.running[e]})):Promise.resolve()},this.use=(e,r)=>{if(t.isArr(e))e.forEach(e=>{t.isFunc(e)?s.use(e):t.isObj(e)&&s.use(e.plugin,e.options)});else{if(!t.isFunc(e))return s;s.state.plugins.push({creator:e,options:r})}return s},this.plugin=(r,n)=>(r.fn&&t.isFunc(r.fn)?e.$.fn[n.toLowerCase()]=function(e){return new r.fn(this,e)}:s.debug.log("Error :: Missing "+r+" fn() method."),s),this.boot=()=>{const e=s.state.plugins.filter(e=>!0!==e.booted).map(e=>()=>new Promise((r,n)=>{try{t.hasArgs(e.creator,3)?e.creator(s,e.options,t=>{t?n(t):(e.booted=!0,r())}):(e.plugin=e.creator(s,e.options),e.booted=!0,r())}catch(e){n(e)}}));return t.run.series(e)},this.attach=async e=>{s.debug.log("Dynamic async module loading."),s.debug.log("Imports:",e)},this},i=()=>new o;new o;const a=i().create("Metrics",e=>{let t=null,r=null,s=null;const n=e=>{const t=Math.floor(e/1e3),r=Math.floor(t/60),s=Math.floor(r/60);return s>0?`${s}h ${r%60}m`:r>0?`${r}m ${t%60}s`:`${t}s`};return{load:(o={})=>{if(e.log("Metrics module loading with options:",o),t=((t=!0)=>{const r={enabled:t,metrics:{routeLoadTimes:new Map,moduleLoadTimes:new Map,totalRoutes:0,totalModules:0,cacheHits:0,cacheMisses:0,errors:0,startTime:Date.now()},timings:new Map},s=()=>{const e=r.metrics.cacheHits+r.metrics.cacheMisses;return e>0?(r.metrics.cacheHits/e*100).toFixed(2):0},n=e=>{const t="route"===e?r.metrics.routeLoadTimes:r.metrics.moduleLoadTimes;return 0===t.size?0:(Array.from(t.values()).reduce((e,t)=>e+t,0)/t.size).toFixed(2)};return{startTiming:e=>{if(!r.enabled)return null;const t=performance.now();return r.timings.set(e,t),t},endTiming:e=>{if(!r.enabled||!r.timings.has(e))return 0;const t=r.timings.get(e),s=performance.now()-t;return e.startsWith("route:")?(r.metrics.routeLoadTimes.set(e,s),r.metrics.totalRoutes++):e.startsWith("module:")&&(r.metrics.moduleLoadTimes.set(e,s),r.metrics.totalModules++),r.timings.delete(e),s},recordCacheHit:()=>{r.enabled&&r.metrics.cacheHits++},recordCacheMiss:()=>{r.enabled&&r.metrics.cacheMisses++},recordError:t=>{r.enabled&&(r.metrics.errors++,e.log("Error recorded:",t))},getMetrics:()=>({...r.metrics,routeLoadTimes:Array.from(r.metrics.routeLoadTimes.entries()),moduleLoadTimes:Array.from(r.metrics.moduleLoadTimes.entries()),uptime:Date.now()-r.metrics.startTime,cacheHitRate:s(),averageRouteLoadTime:n("route"),averageModuleLoadTime:n("module")}),getCacheHitRate:s,getAverageLoadTime:n,reset:()=>{r.metrics={routeLoadTimes:new Map,moduleLoadTimes:new Map,totalRoutes:0,totalModules:0,cacheHits:0,cacheMisses:0,errors:0,startTime:Date.now()},r.timings.clear()}}})(!1!==o.enabled),e.add("route:start",r=>{const s=`route:${r.path||"unknown"}`;t.startTiming(s),e.log("Route started:",s)}),e.add("route:complete",r=>{const s=`route:${r.path||"unknown"}`,n=t.endTiming(s);e.log(`Route completed: ${s} in ${n}ms`),e.emit("metrics:updated",t.getMetrics())}),e.add("module:start",r=>{const s=`module:${r.name||"unknown"}`;t.startTiming(s),e.log("Module started:",s)}),e.add("module:complete",r=>{const s=`module:${r.name||"unknown"}`,n=t.endTiming(s);e.log(`Module loaded: ${s} in ${n}ms`),e.emit("metrics:updated",t.getMetrics())}),e.add("cache:hit",()=>{t.recordCacheHit()}),e.add("cache:miss",()=>{t.recordCacheMiss()}),e.add("error",e=>{t.recordError(e)}),o.displayMetrics){s=e.$("#metrics-display"),0===s.length&&(s=e.$('<div id="metrics-display"></div>'),e.$("body").append(s));const i=o.updateInterval||5e3;r=setInterval(()=>{(()=>{if(!s||!t)return;const e=t.getMetrics(),r=`\n      <div class="metrics-panel">\n        <h3>Performance Metrics</h3>\n        <div class="metric-item">\n          <span class="label">Uptime:</span>\n          <span class="value">${n(e.uptime)}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Total Routes:</span>\n          <span class="value">${e.totalRoutes}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Total Modules:</span>\n          <span class="value">${e.totalModules}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Avg Route Load:</span>\n          <span class="value">${e.averageRouteLoadTime}ms</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Avg Module Load:</span>\n          <span class="value">${e.averageModuleLoadTime}ms</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Cache Hit Rate:</span>\n          <span class="value">${e.cacheHitRate}%</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Cache Hits:</span>\n          <span class="value">${e.cacheHits}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Cache Misses:</span>\n          <span class="value">${e.cacheMisses}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Errors:</span>\n          <span class="value">${e.errors}</span>\n        </div>\n      </div>\n    `;s.html(r)})()},i)}return e.metrics={start:e=>t.startTiming(e),end:e=>t.endTiming(e),cacheHit:()=>t.recordCacheHit(),cacheMiss:()=>t.recordCacheMiss(),recordError:e=>t.recordError(e),get:()=>t.getMetrics(),reset:()=>t.reset()},e.log("Metrics module loaded successfully"),Promise.resolve()},unload:()=>(e.log("Metrics module unloading"),r&&(clearInterval(r),r=null),s&&(s.remove(),s=null),delete e.metrics,Promise.resolve()),destroy:()=>{e.log("Metrics module destroying"),t&&(t.reset(),t=null)},getSnapshot:()=>t?t.getMetrics():null,reset:()=>{t&&(t.reset(),e.emit("metrics:reset"),e.log("Metrics reset"))}}},{enabled:!0,displayMetrics:!1,updateInterval:5e3});$.FEAR=function(e){const t=i();return e&&t.configure(e),t},$.FEAR.utils=t,$.FEAR.createBroker=s,$.FEAR.createRegistry=()=>(new n).create(),$.FEAR.Metrics=a,$.FEAR.version="1.0.2",$.fear=i(),window.FEAR=$.FEAR,window.fear=$.fear});
